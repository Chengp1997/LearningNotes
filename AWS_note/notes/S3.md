# S3 

[官方文档](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html)

[AWS SDK for Java S3 Example](https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/examples-s3.html)

[Full example in Github](https://github.com/awsdocs/aws-doc-sdk-examples/tree/main/java/example_code/s3/src/main/java/aws/example/s3)

## 创建桶

如果需要外部访问，需要设置对应的policy

设置**public access**

![image-20221117180759304](/Users/chengeping/Library/Application Support/typora-user-images/image-20221117180759304.png)

**对应policy**

需要外部可以进行访问的对应policy

```java
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "publicReadForGetBucketObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::ridenshare/image/*"
        }
    ]
}
```

## Credential

如果需要通过代码来进行处理，记得要在IAM创建对应的user，生成对应的security access。

通过public key，secret key来创建credential从而完成操作。



## 对象操作

### upload

- Amazon S3 创建连接并上传。

```java
@Component
public class AWSS3Utils {

//    @Value("${AmazonS3.accessKey}")
    private String accessKey="";
//    @Value("${AmazonS3.accessSecretKey}")
    private String secretKey="";
    public static  final String url = "https://s3.amazonaws.com/ridenshare/image/";
    private final static String bucketName = "ridenshare/image";

    public boolean upload(String fileName, MultipartFile file) {
        try {
            amazonS3().putObject(bucketName,fileName,multipartToFile(file,fileName));
            return true;
        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }

    private AmazonS3 amazonS3(){
        AWSCredentials awsCredentials = new BasicAWSCredentials(accessKey,secretKey);
        return   AmazonS3ClientBuilder
                .standard()
                .withRegion(Regions.US_EAST_1)
                .withCredentials(new AWSStaticCredentialsProvider(awsCredentials))
                .build();
    }

    public  static File multipartToFile(MultipartFile multipart, String fileName) throws IllegalStateException, IOException {
        File convFile = new File(System.getProperty("java.io.tmpdir")+"/"+fileName);
        multipart.transferTo(convFile);
        return convFile;
    }

}
```